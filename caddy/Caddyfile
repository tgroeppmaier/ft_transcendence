{
	local_certs
}

localhost {
    # 1. WebSocket
    @ws {
        path /api/ws
        path /api/ws/*
    }
    handle @ws {
        reverse_proxy backend:3000
    }

    # 2. Game, Invite & Tournament API
    @backend_api {
        path /api/games
        path /api/games/*
        path /api/invite
        path /api/invites
        path /api/invite/*
        path /api/tournament
        path /api/tournament/*
    }
    handle @backend_api {
        reverse_proxy backend:3000
    }

    # 3. Database API
    @api path /api/*
    handle @api {
        uri strip_prefix /api
        reverse_proxy database:3000
    }

    # 4. Frontend
    handle {
        root * /usr/share/caddy
        file_server
        try_files {path} /index.html
    }
    # 3. Google OAuth callback
    @google_auth {
        path /api/auth/google
        path /api/auth/google/*
    }
    handle @google_auth {
        uri strip_prefix /api
        reverse_proxy database:3000
    }

}

# Redirect HTTP
http://localhost:80 {
    redir https://localhost:8443{uri}
}
