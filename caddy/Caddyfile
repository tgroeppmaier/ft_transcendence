{
    debug
}

:443 {
    tls {
        issuer internal
        on_demand
    }

    # 1. WebSocket
    @ws {
        path /api/ws
        path /api/ws/*
    }
    handle @ws {
        reverse_proxy backend:3000
    }

    # 2. Game & Invite API
    @backend_api {
        path /api/games
        path /api/games/*
    }
    handle @backend_api {
        reverse_proxy backend:3000
    }

    # 3. Block internal DB routes from public access
    @db_internal {
        path /db/internal
        path /db/internal/*
    }
    handle @db_internal {
        respond "Forbidden" 403
    }

    # 3. Database API
    @db path /db/*
    handle @db {
        uri strip_prefix /db
        reverse_proxy database:3000
    }

    # 4. Frontend
    handle {
        root * /usr/share/caddy
        file_server
        try_files {path} /index.html
    }
    # 3. Google OAuth callback
    @google_auth {
        path /api/auth/google
        path /api/auth/google/*
    }
    handle @google_auth {
        uri strip_prefix /api
        reverse_proxy database:3000
    }

}

# Redirect HTTP
:80 {
    redir https://{host}:8443{uri}
}
