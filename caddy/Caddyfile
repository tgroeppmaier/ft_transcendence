:443 {
    tls {
        issuer internal
        on_demand
    }

    # 1. WebSocket (Backend)
    @ws {
        path /api/ws
        path /api/ws/*
    }
    handle @ws {
        reverse_proxy backend:3000
    }

    # 2. Game API (Backend)
    @backend_api {
        path /api/games
        path /api/games/*
    }
    handle @backend_api {
        reverse_proxy backend:3000
    }

    # 3. Block internal DB routes from public access
    @db_internal {
        path /db/internal
        path /db/internal/*
    }
    handle @db_internal {
        respond "Forbidden" 403
    }

    # 4. Database API (все Auth тоже здесь!)
    @db path /db/*
    handle @db {
        uri strip_prefix /db
        reverse_proxy database:3000
    }

    # 5. Static uploads
    @uploads {
        path /uploads/*
    }
    handle @uploads {
        root * /usr/share/caddy
        file_server
    }

    # 6. Frontend (SPA)
    handle {
        root * /usr/share/caddy
        file_server
        try_files {path} /index.html
    }
}

# Redirect HTTP → HTTPS
:80 {
    redir https://{host}:8443{uri}
}
